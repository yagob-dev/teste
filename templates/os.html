{% extends "base.html" %} {% block title %}Ordens de Servi√ßo - TechAI Assist{%
endblock %} {% set active_page = 'os' %} {% block content %}
<div class="page-header">
  <div class="page-title">
    <h1>Ordens de Servi√ßo</h1>
  </div>
  <div class="header-actions-btn">
    <button class="export-card" onclick="exportarOS()">üìä Exportar</button>
    <button class="btn btn-primary" onclick="abrirModal('novaOS')">
      ‚ûï Nova O.S
    </button>
  </div>
</div>

<!-- CARDS DE ESTAT√çSTICAS -->
<div class="stats-grid">
  <div class="stat-card" onclick="filtrarPorStatus('')">
    <div class="stat-icon blue">üìã</div>
    <div class="stat-info">
      <h3 id="totalOS">0</h3>
      <p>Total de O.S</p>
    </div>
  </div>

  <div class="stat-card" onclick="filtrarPorStatus('aguardando')">
    <div class="stat-icon yellow">‚è≥</div>
    <div class="stat-info">
      <h3 id="osAguardando">0</h3>
      <p>Aguardando</p>
    </div>
  </div>

  <div class="stat-card" onclick="filtrarPorStatus('em_reparo')">
    <div class="stat-icon green">üîß</div>
    <div class="stat-info">
      <h3 id="osEmReparo">0</h3>
      <p>Em Reparo</p>
    </div>
  </div>

  <div class="stat-card" onclick="filtrarPorStatus('atrasadas')">
    <div class="stat-icon red">‚ö†Ô∏è</div>
    <div class="stat-info">
      <h3 id="osAtrasadas">0</h3>
      <p>Atrasadas</p>
    </div>
  </div>
</div>

<!-- FILTROS -->
<div class="filters-section">
  <div class="filter-controls">
    <select id="filtroStatus" class="filter-btn">
      <option value="">Todos os Status</option>
      <option value="aguardando">Aguardando</option>
      <option value="em_reparo">Em Reparo</option>
      <option value="pronto">Pronto</option>
      <option value="entregue">Entregue</option>
      <option value="cancelado">Cancelado</option>
    </select>
    <select id="filtroPrioridade" class="filter-btn">
      <option value="">Todas as Prioridades</option>
      <option value="baixa">Baixa</option>
      <option value="normal">Normal</option>
      <option value="alta">Alta</option>
      <option value="urgente">Urgente</option>
    </select>
    <button class="filter-btn active" data-filtro="todas">Todas</button>
    <button class="filter-btn" data-filtro="hoje">Hoje</button>
    <button class="filter-btn" data-filtro="semana">Esta Semana</button>
  </div>
  <div class="results-info">
    <span id="resultadosInfo">Mostrando 0 ordens de servi√ßo</span>
  </div>
</div>

<!-- TABELA DE ORDENS DE SERVI√áO -->
<div class="os-section">
  <div class="section-header">
    <h2>Lista de Ordens de Servi√ßo</h2>
    <div class="table-actions">
      <button class="btn btn-secondary" onclick="limparFiltros()">
        üîÑ Limpar Filtros
      </button>
    </div>
  </div>

  <div class="table-container">
    <table class="os-table" id="osTable">
      <thead>
        <tr>
          <th>N√∫mero</th>
          <th>Cliente</th>
          <th>Aparelho</th>
          <th>Problema</th>
          <th>Status</th>
          <th>Prioridade</th>
          <th>Data</th>
          <th>Prazo</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="osTableBody">
        <!-- Dados ser√£o inseridos via JavaScript -->
      </tbody>
    </table>
  </div>

  <!-- Pagina√ß√£o -->
  <div class="pagination" id="pagination">
    <!-- Pagina√ß√£o ser√° inserida via JavaScript -->
  </div>
</div>
{% endblock %} {% block extra_body %}
<!-- MODAL NOVA/EDITAR O.S -->
<div class="modal" id="modalOS">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">Nova Ordem de Servi√ßo</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>

    <form id="formOS">
      <input type="hidden" id="osId" name="id" />

      <div class="form-row">
        <div class="form-group">
          <label for="numeroOS">N√∫mero da O.S</label>
          <input
            type="text"
            id="numeroOS"
            name="numeroOS"
            placeholder="Auto-gerado"
            readonly
          />
        </div>
        <div class="form-group">
          <label for="prioridade">Prioridade *</label>
          <select id="prioridade" name="prioridade" required>
            <option value="">Selecione...</option>
            <option value="baixa">Baixa</option>
            <option value="normal" selected>Normal</option>
            <option value="alta">Alta</option>
            <option value="urgente">Urgente</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="cliente">Cliente *</label>
        <select id="cliente" name="clienteId" required>
          <option value="">Selecione o cliente...</option>
          <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="tipoAparelho">Tipo de Aparelho *</label>
          <select id="tipoAparelho" name="tipoAparelho" required>
            <option value="">Selecione...</option>
            <option value="smartphone">Smartphone</option>
            <option value="tablet">Tablet</option>
            <option value="notebook">Notebook</option>
            <option value="desktop">Desktop</option>
            <option value="outro">Outro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="marcaModelo">Marca/Modelo *</label>
          <input
            type="text"
            id="marcaModelo"
            name="marcaModelo"
            placeholder="Ex: iPhone 12 Pro"
            required
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="imeiSerial">IMEI/Serial</label>
          <input
            type="text"
            id="imeiSerial"
            name="imeiSerial"
            placeholder="N√∫mero de s√©rie"
          />
        </div>
        <div class="form-group">
          <label for="corAparelho">Cor</label>
          <input
            type="text"
            id="corAparelho"
            name="corAparelho"
            placeholder="Ex: Preto, Branco"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="problemaRelatado">Problema Relatado *</label>
        <textarea
          id="problemaRelatado"
          name="problemaRelatado"
          rows="4"
          placeholder="Descreva o problema reportado pelo cliente"
          required
        ></textarea>
      </div>

      <div class="form-group">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <label for="diagnosticoTecnico">Pr√©-diagn√≥stico</label>
          <button
            type="button"
            class="btn btn-secondary"
            id="btnGerarDiagnostico"
            onclick="gerarDiagnosticoAI()"
            style="font-size: 12px; padding: 6px 12px"
          >
            üß† Diagn√≥stico Preview
          </button>
        </div>
        <textarea
          id="diagnosticoTecnico"
          name="diagnosticoTecnico"
          rows="3"
          placeholder="Pr√©-diagn√≥stico gerado pela IA ou realizado pelo t√©cnico"
        ></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="prazoEstimado">Prazo Estimado (dias) *</label>
          <input
            type="number"
            id="prazoEstimado"
            name="prazoEstimado"
            value="3"
            min="1"
            required
          />
        </div>
        <div class="form-group">
          <label for="valorOrcamento">Valor do Or√ßamento</label>
          <input
            type="text"
            id="valorOrcamento"
            name="valorOrcamento"
            placeholder="R$ 0,00"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="observacoes">Observa√ß√µes</label>
        <textarea
          id="observacoes"
          name="observacoes"
          rows="3"
          placeholder="Informa√ß√µes adicionais sobre a O.S"
        ></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="fecharModal()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" id="submitBtn">
          Salvar O.S
        </button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL VISUALIZAR O.S -->
<div class="modal" id="modalVisualizar">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Detalhes da Ordem de Servi√ßo</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>

    <div id="osDetalhes">
      <!-- Detalhes ser√£o inseridos via JavaScript -->
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" onclick="fecharModal()">
        Fechar
      </button>
      <button type="button" class="btn btn-primary" onclick="editarOSAtual()">
        Editar
      </button>
    </div>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script src="/js/clientes.js"></script>
<script>
  // ========================================
  // SCRIPT DA P√ÅGINA DE ORDENS DE SERVI√áO
  // ========================================

  // Array que mant√©m as OS em mem√≥ria durante a sess√£o
  let osEmMemoria = [];

  // Vari√°veis globais
  let osFiltradas = [];
  let osAtual = null;
  let paginaAtual = 1;
  const itensPorPagina = 10;
  let filtroEspecial = null; // Para filtros especiais como "atrasadas"

  // Elementos do DOM (ser√£o definidos dentro do DOMContentLoaded)
  let searchInput,
    osTableBody,
    pagination,
    totalOS,
    osAguardando,
    osEmReparo,
    osAtrasadas,
    resultadosInfo;

  // ============================
  // FUN√á√ïES DE DADOS
  // ============================

  /**
   * Carrega todas as OS da API
   */
  async function carregarOS() {
    try {
      console.log("üì° Fazendo requisi√ß√£o para API de OS...");
      const os = await listarOSApi();
      console.log("üì¶ Dados recebidos da API:", os);

      osEmMemoria = os || [];
      console.log("‚úÖ OS carregadas na mem√≥ria:", osEmMemoria.length);

      // Log detalhado das OS carregadas
      osEmMemoria.forEach((os, index) => {
        console.log(
          `  ${index + 1}. ${os.numeroOS} - ${os.clienteNome} - ${os.status}`
        );
      });

      return osEmMemoria;
    } catch (e) {
      console.error("‚ùå Erro ao carregar OS:", e);
      osEmMemoria = [];
      return osEmMemoria;
    }
  }

  /**
   * Adiciona uma nova OS via API
   */
  async function adicionarOS(os) {
    try {
      console.log("üìù Tentando criar OS:", os);
      const criado = await criarOSApi(os);
      console.log("‚úÖ OS criada na API:", criado);

      // Adiciona ao array local tamb√©m
      osEmMemoria.push(criado);

      console.log("‚úÖ OS adicionada ao array local:", criado.numeroOS);
      return criado;
    } catch (e) {
      console.error("‚ùå Erro ao adicionar OS:", e);
      throw e;
    }
  }

  /**
   * Atualiza uma OS existente via API
   */
  async function atualizarOS(id, dadosAtualizados) {
    const indice = osEmMemoria.findIndex((o) => o.id === parseInt(id));

    if (indice === -1) {
      console.error("‚ùå OS n√£o encontrada:", id);
      throw new Error("OS n√£o encontrada");
    }

    try {
      const atualizado = await atualizarOSApi(id, dadosAtualizados);
      osEmMemoria[indice] = atualizado;

      console.log("‚úÖ OS atualizada:", atualizado.numeroOS);
      return true;
    } catch (e) {
      console.error("‚ùå Erro ao atualizar OS:", e);
      throw e;
    }
  }

  /**
   * Busca uma OS por ID
   */
  function buscarOSPorId(id) {
    return osEmMemoria.find((o) => o.id === parseInt(id)) || null;
  }

  /**
   * Busca OS por termo
   */
  function buscarOS(termo) {
    if (!termo || termo.trim() === "") {
      return osEmMemoria;
    }

    const termoLower = termo.toLowerCase();

    return osEmMemoria.filter((os) => {
      return (
        os.numeroOS.toLowerCase().includes(termoLower) ||
        os.clienteNome?.toLowerCase().includes(termoLower) ||
        os.marcaModelo.toLowerCase().includes(termoLower) ||
        os.problemaRelatado.toLowerCase().includes(termoLower)
      );
    });
  }

  /**
   * Valida formul√°rio de OS
   */
  function validarFormularioOS(dados) {
    const erros = [];

    if (!dados.clienteId || dados.clienteId.trim() === "") {
      erros.push("Cliente √© obrigat√≥rio");
    }

    if (!dados.tipoAparelho || dados.tipoAparelho.trim() === "") {
      erros.push("Tipo de aparelho √© obrigat√≥rio");
    }

    if (!dados.marcaModelo || dados.marcaModelo.trim() === "") {
      erros.push("Marca/Modelo √© obrigat√≥rio");
    }

    if (!dados.problemaRelatado || dados.problemaRelatado.trim() === "") {
      erros.push("Problema relatado √© obrigat√≥rio");
    }

    if (!dados.prazoEstimado || dados.prazoEstimado < 1) {
      erros.push("Prazo estimado deve ser pelo menos 1 dia");
    }

    return {
      valido: erros.length === 0,
      erros: erros,
    };
  }

  // ============================
  // FUN√á√ïES DE INTERFACE
  // ============================

  /**
   * Atualiza as estat√≠sticas na tela
   */
  function atualizarEstatisticas() {
    const total = osEmMemoria.length;
    const aguardando = osEmMemoria.filter(
      (o) => o.status === "aguardando"
    ).length;
    const emReparo = osEmMemoria.filter((o) => o.status === "em_reparo").length;

    // Calcula OS atrasadas (prazo vencido e n√£o entregue)
    const hoje = new Date();
    const atrasadas = osEmMemoria.filter((os) => {
      if (os.status === "entregue" || os.status === "cancelado") return false;

      const dataCriacao = new Date(os.dataCriacao);
      const prazoLimite = new Date(dataCriacao);
      prazoLimite.setDate(prazoLimite.getDate() + (os.prazoEstimado || 3));

      return hoje > prazoLimite;
    }).length;

    totalOS.textContent = total;
    osAguardando.textContent = aguardando;
    osEmReparo.textContent = emReparo;
    osAtrasadas.textContent = atrasadas;
  }

  /**
   * Renderiza a tabela de OS
   */
  function renderizarTabela() {
    const inicio = (paginaAtual - 1) * itensPorPagina;
    const fim = inicio + itensPorPagina;
    const osPagina = osFiltradas.slice(inicio, fim);

    osTableBody.innerHTML = "";

    if (osPagina.length === 0) {
      osTableBody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: var(--gray-medium);">
                            <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
                            <div>Nenhuma ordem de servi√ßo encontrada</div>
                            <div style="font-size: 14px; margin-top: 10px;">
                                ${
                                  osEmMemoria.length === 0
                                    ? "Crie sua primeira O.S!"
                                    : "Tente ajustar os filtros de busca."
                                }
                            </div>
                        </td>
                    </tr>
                `;
      return;
    }

    osPagina.forEach((os) => {
      const row = document.createElement("tr");
      const dataCriacao = new Date(os.dataCriacao);
      const prazoLimite = new Date(dataCriacao);
      prazoLimite.setDate(prazoLimite.getDate() + (os.prazoEstimado || 3));
      const hoje = new Date();
      const atrasada =
        hoje > prazoLimite &&
        os.status !== "entregue" &&
        os.status !== "cancelado";

      // Verificar se OS est√° entregue (n√£o permite edi√ß√£o)
      const entregue = os.status === "entregue";

      row.innerHTML = `
                    <td><strong>${os.numeroOS}</strong></td>
                    <td>${os.clienteNome || os.cliente}</td>
                    <td>
                        <div class="aparelho-info">
                            <div class="aparelho-icon">üì±</div>
                            <span>${os.marcaModelo}</span>
                        </div>
                    </td>
                    <td class="problema-cell">${os.problemaRelatado.substring(
                      0,
                      50
                    )}${os.problemaRelatado.length > 50 ? "..." : ""}</td>
                    <td>
                        <select class="status-select" onchange="mudarStatusOS('${
                          os.id
                        }', this.value)" data-os-id="${os.id}" ${
        entregue ? "disabled" : ""
      }>
                            <option value="aguardando" ${
                              os.status === "aguardando" ? "selected" : ""
                            }>Aguardando</option>
                            <option value="em_reparo" ${
                              os.status === "em_reparo" ? "selected" : ""
                            }>Em Reparo</option>
                            <option value="pronto" ${
                              os.status === "pronto" ? "selected" : ""
                            }>Pronto</option>
                            <option value="entregue" ${
                              os.status === "entregue" ? "selected" : ""
                            }>Entregue</option>
                            <option value="cancelado" ${
                              os.status === "cancelado" ? "selected" : ""
                            }>Cancelado</option>
                        </select>
                    </td>
                    <td><span class="prioridade-badge ${
                      os.prioridade
                    }">${getPrioridadeText(os.prioridade)}</span></td>
                    <td>${formatarData(os.dataCriacao)}</td>
                    <td class="${atrasada ? "atrasada" : ""}">${formatarData(
        prazoLimite
      )}</td>
                    <td>
                        <div class="actions-cell">
                            <button class="action-btn-small btn-view" onclick="visualizarOS('${
                              os.id
                            }')" title="Visualizar">
                                üëÅÔ∏è
                            </button>
                            <button class="action-btn-small btn-edit" onclick="editarOS('${
                              os.id
                            }')" title="Editar" ${entregue ? "disabled" : ""}>
                                ‚úèÔ∏è
                            </button>
                        </div>
                    </td>
                `;
      osTableBody.appendChild(row);
    });

    // Atualiza informa√ß√µes de resultados
    resultadosInfo.textContent = `Mostrando ${osPagina.length} de ${osFiltradas.length} ordens de servi√ßo`;
  }

  /**
   * Renderiza a pagina√ß√£o
   */
  function renderizarPaginacao() {
    const totalPaginas = Math.ceil(osFiltradas.length / itensPorPagina);

    if (totalPaginas <= 1) {
      pagination.innerHTML = "";
      return;
    }

    let paginacaoHTML = '<div class="pagination-controls">';

    // Bot√£o anterior
    if (paginaAtual > 1) {
      paginacaoHTML += `<button class="pagination-btn" onclick="irParaPagina(${
        paginaAtual - 1
      })">‚Äπ Anterior</button>`;
    }

    // N√∫meros das p√°ginas
    for (let i = 1; i <= totalPaginas; i++) {
      if (i === paginaAtual) {
        paginacaoHTML += `<button class="pagination-btn active">${i}</button>`;
      } else {
        paginacaoHTML += `<button class="pagination-btn" onclick="irParaPagina(${i})">${i}</button>`;
      }
    }

    // Bot√£o pr√≥ximo
    if (paginaAtual < totalPaginas) {
      paginacaoHTML += `<button class="pagination-btn" onclick="irParaPagina(${
        paginaAtual + 1
      })">Pr√≥ximo ‚Ä∫</button>`;
    }

    paginacaoHTML += "</div>";
    pagination.innerHTML = paginacaoHTML;
  }

  /**
   * Vai para uma p√°gina espec√≠fica
   */
  function irParaPagina(pagina) {
    paginaAtual = pagina;
    renderizarTabela();
    renderizarPaginacao();
  }

  /**
   * Aplica filtros de busca
   */
  function aplicarFiltros() {
    const termoBusca = searchInput.value.trim();
    const filtroStatus = document.getElementById("filtroStatus").value;
    const filtroPrioridade = document.getElementById("filtroPrioridade").value;
    const filtroTempo =
      document
        .querySelector(".filter-btn.active[data-filtro]")
        ?.getAttribute("data-filtro") || "todas";

    // Busca por termo
    let os = buscarOS(termoBusca);

    // Filtro por status ou filtro especial
    if (filtroEspecial === "atrasadas") {
      const hoje = new Date();
      os = os.filter((os) => {
        if (os.status === "entregue" || os.status === "cancelado") return false;
        const dataCriacao = new Date(os.dataCriacao);
        const prazoLimite = new Date(dataCriacao);
        prazoLimite.setDate(prazoLimite.getDate() + (os.prazoEstimado || 3));
        return hoje > prazoLimite;
      });
    } else if (filtroStatus) {
      os = os.filter((o) => o.status === filtroStatus);
    }

    // Filtro por prioridade
    if (filtroPrioridade) {
      os = os.filter((o) => o.prioridade === filtroPrioridade);
    }

    // Filtro por tempo
    if (filtroTempo !== "todas") {
      const hoje = new Date();
      const inicioSemana = new Date(hoje);
      inicioSemana.setDate(hoje.getDate() - hoje.getDay());

      os = os.filter((o) => {
        const dataOS = new Date(o.dataCriacao);

        if (filtroTempo === "hoje") {
          return dataOS.toDateString() === hoje.toDateString();
        } else if (filtroTempo === "semana") {
          return dataOS >= inicioSemana;
        }
        return true;
      });
    }

    osFiltradas = os;
    paginaAtual = 1;
    renderizarTabela();
    renderizarPaginacao();
  }

  /**
   * Limpa todos os filtros
   */
  function limparFiltros() {
    searchInput.value = "";
    document.getElementById("filtroStatus").value = "";
    document.getElementById("filtroPrioridade").value = "";
    document.querySelectorAll(".filter-btn[data-filtro]").forEach((btn) => {
      btn.classList.remove("active");
    });
    document
      .querySelector('.filter-btn[data-filtro="todas"]')
      .classList.add("active");

    filtroEspecial = null; // Reset filtro especial

    aplicarFiltros();
  }

  /**
   * Filtra OS por status (usado pelos cards de estat√≠sticas)
   */
  function filtrarPorStatus(status) {
    if (status === "atrasadas") {
      filtroEspecial = "atrasadas";
      document.getElementById("filtroStatus").value = "";
    } else {
      filtroEspecial = null;
      document.getElementById("filtroStatus").value = status;
    }
    aplicarFiltros();
  }

  // ============================
  // FUN√á√ïES AUXILIARES
  // ============================

  /**
   * Retorna texto do status
   */
  function getStatusText(status) {
    const statusMap = {
      aguardando: "Aguardando",
      em_reparo: "Em Reparo",
      pronto: "Pronto",
      entregue: "Entregue",
      cancelado: "Cancelado",
    };
    return statusMap[status] || status;
  }

  /**
   * Retorna texto da prioridade
   */
  function getPrioridadeText(prioridade) {
    const prioridadeMap = {
      baixa: "Baixa",
      normal: "Normal",
      alta: "Alta",
      urgente: "Urgente",
    };
    return prioridadeMap[prioridade] || prioridade;
  }

  /**
   * Carrega clientes no select
   */
  function carregarClientesSelect() {
    const selectCliente = document.getElementById("cliente");
    selectCliente.innerHTML =
      '<option value="">Selecione o cliente...</option>';

    clientesEmMemoria.forEach((cliente) => {
      const option = document.createElement("option");
      option.value = cliente.id; // Usar ID como valor
      option.textContent = cliente.nome;
      selectCliente.appendChild(option);
    });
  }

  // ============================
  // FUN√á√ïES DE MODAL
  // ============================

  // ============================
  // FUN√á√ïES GLOBAIS (dispon√≠veis para onclick)
  // ============================

  /**
   * Abre modal para nova OS ou edi√ß√£o (fun√ß√£o global)
   */
  window.abrirModal = function (tipo, osId = null) {
    const modal = document.getElementById("modalOS");
    const modalTitle = document.getElementById("modalTitle");
    const form = document.getElementById("formOS");
    const submitBtn = document.getElementById("submitBtn");

    if (tipo === "novaOS") {
      modalTitle.textContent = "Nova Ordem de Servi√ßo";
      form.reset();
      document.getElementById("osId").value = "";
      document.getElementById("numeroOS").value = "Ser√° gerado automaticamente";
      submitBtn.textContent = "Criar O.S";
    } else if (tipo === "editarOS" && osId) {
      const os = buscarOSPorId(osId);
      if (os) {
        modalTitle.textContent = "Editar Ordem de Servi√ßo";
        preencherFormulario(os);
        submitBtn.textContent = "Atualizar O.S";
      }
    }

    // Carrega clientes no select
    carregarClientesSelect();

    // Configura event listener do formul√°rio (sempre que o modal √© aberto)
    configurarEventListenerFormulario();

    modal.classList.add("active");
  };

  /**
   * Fecha todos os modais
   */
  function fecharModal() {
    document.querySelectorAll(".modal").forEach((modal) => {
      modal.classList.remove("active");
    });
  }

  /**
   * Preenche formul√°rio com dados da OS
   */
  function preencherFormulario(os) {
    document.getElementById("osId").value = os.id;
    document.getElementById("numeroOS").value = os.numeroOS;
    document.getElementById("prioridade").value = os.prioridade || "normal";
    document.getElementById("cliente").value = os.clienteId; // Usar ID do cliente
    document.getElementById("tipoAparelho").value = os.tipoAparelho;
    document.getElementById("marcaModelo").value = os.marcaModelo;
    document.getElementById("imeiSerial").value = os.imeiSerial || "";
    document.getElementById("corAparelho").value = os.corAparelho || "";
    document.getElementById("problemaRelatado").value = os.problemaRelatado;
    document.getElementById("diagnosticoTecnico").value =
      os.diagnosticoTecnico || "";
    document.getElementById("prazoEstimado").value = os.prazoEstimado || 3;
    document.getElementById("valorOrcamento").value = os.valorOrcamento || "";
    document.getElementById("observacoes").value = os.observacoes || "";
  }

  // ============================
  // FUN√á√ïES DE CRUD
  // ============================

  /**
   * Visualiza detalhes da OS
   */
  function visualizarOS(id) {
    const os = buscarOSPorId(id);
    if (!os) return;

    osAtual = os;
    const modal = document.getElementById("modalVisualizar");
    const detalhes = document.getElementById("osDetalhes");

    const dataCriacao = new Date(os.dataCriacao);
    const prazoLimite = new Date(dataCriacao);
    prazoLimite.setDate(prazoLimite.getDate() + (os.prazoEstimado || 3));
    const hoje = new Date();
    const atrasada =
      hoje > prazoLimite &&
      os.status !== "entregue" &&
      os.status !== "cancelado";

    detalhes.innerHTML = `
                <div class="os-details">
                    <div class="os-header">
                        <div class="os-number">${os.numeroOS}</div>
                        <div class="os-status">
                            <span class="status-badge ${
                              os.status
                            }">${getStatusText(os.status)}</span>
                            <span class="prioridade-badge ${
                              os.prioridade
                            }">${getPrioridadeText(os.prioridade)}</span>
                        </div>
                    </div>

                    <div class="os-details-grid">
                        <div class="detail-item">
                            <label>Cliente:</label>
                            <span>${os.clienteNome}</span>
                        </div>
                        <div class="detail-item">
                            <label>Tipo de Aparelho:</label>
                            <span>${os.tipoAparelho}</span>
                        </div>
                        <div class="detail-item">
                            <label>Marca/Modelo:</label>
                            <span>${os.marcaModelo}</span>
                        </div>
                        <div class="detail-item">
                            <label>IMEI/Serial:</label>
                            <span>${os.imeiSerial || "N√£o informado"}</span>
                        </div>
                        <div class="detail-item">
                            <label>Cor:</label>
                            <span>${os.corAparelho || "N√£o informado"}</span>
                        </div>
                        <div class="detail-item">
                            <label>Data de Cria√ß√£o:</label>
                            <span>${formatarDataHora(os.dataCriacao)}</span>
                        </div>
                        <div class="detail-item">
                            <label>Prazo Estimado:</label>
                            <span>${os.prazoEstimado} dias</span>
                        </div>
                        <div class="detail-item">
                            <label>Prazo Limite:</label>
                            <span class="${
                              atrasada ? "atrasada" : ""
                            }">${formatarData(prazoLimite)}</span>
                        </div>
                        <div class="detail-item">
                            <label>Valor do Or√ßamento:</label>
                            <span>${os.valorOrcamento || "N√£o informado"}</span>
                        </div>
                        <div class="detail-item full-width">
                            <label>Problema Relatado:</label>
                            <span>${os.problemaRelatado}</span>
                        </div>
                        ${
                          os.diagnosticoTecnico
                            ? `
                        <div class="detail-item full-width">
                            <label>Diagn√≥stico T√©cnico:</label>
                            <span>${os.diagnosticoTecnico}</span>
                        </div>
                        `
                            : ""
                        }
                        ${
                          os.observacoes
                            ? `
                        <div class="detail-item full-width">
                            <label>Observa√ß√µes:</label>
                            <span>${os.observacoes}</span>
                        </div>
                        `
                            : ""
                        }
                    </div>
                </div>
            `;

    modal.classList.add("active");
  }

  /**
   * Edita OS
   */
  function editarOS(id) {
    const os = buscarOSPorId(id);
    if (!os) return;

    // Verificar se OS est√° entregue
    if (os.status === "entregue") {
      alert("Ordens de servi√ßo entregues n√£o podem ser editadas.");
      return;
    }

    abrirModal("editarOS", id);
  }

  /**
   * Edita a OS atual (do modal de visualiza√ß√£o)
   */
  function editarOSAtual() {
    if (osAtual) {
      // Verificar se OS est√° entregue
      if (osAtual.status === "entregue") {
        alert("Ordens de servi√ßo entregues n√£o podem ser editadas.");
        return;
      }

      fecharModal();
      setTimeout(() => {
        editarOS(osAtual.id);
      }, 300);
    }
  }

  /**
   * Muda o status de uma OS
   */
  async function mudarStatusOS(osId, novoStatus) {
    const os = buscarOSPorId(osId);
    if (!os) {
      console.error("OS n√£o encontrada:", osId);
      return;
    }

    // Confirma√ß√£o para status cr√≠ticos
    if (novoStatus === "cancelado") {
      const confirmado = confirm(
        `Tem certeza que deseja CANCELAR a O.S "${os.numeroOS}"?\n\nEsta a√ß√£o marcar√° a OS como cancelada.`
      );
      if (!confirmado) {
        // Reverte o select para o status anterior
        const select = document.querySelector(`select[data-os-id="${osId}"]`);
        if (select) {
          select.value = os.status;
        }
        return;
      }
    }

    try {
      // Desabilita o select durante a atualiza√ß√£o
      const select = document.querySelector(`select[data-os-id="${osId}"]`);
      if (select) {
        select.disabled = true;
      }

      // Atualiza via API
      await atualizarOSApi(osId, { status: novoStatus });

      // Recarrega dados da API para garantir sincroniza√ß√£o
      await carregarOS();

      // Atualiza estat√≠sticas e filtros
      atualizarEstatisticas();
      aplicarFiltros();

      // Atualiza notifica√ß√µes se dispon√≠vel
      if (window.notificationManager) {
        window.notificationManager.atualizarContador();
      }

      console.log(
        `‚úÖ Status da OS ${os.numeroOS} alterado para: ${getStatusText(
          novoStatus
        )}`
      );
    } catch (error) {
      console.error("‚ùå Erro ao alterar status:", error);

      // Reverte o select para o status anterior
      const select = document.querySelector(`select[data-os-id="${osId}"]`);
      if (select) {
        select.value = os.status;
      }

      alert("Erro ao alterar o status da O.S. Tente novamente.");
    } finally {
      // Reabilita o select
      const select = document.querySelector(`select[data-os-id="${osId}"]`);
      if (select) {
        select.disabled = false;
      }
    }
  }

  /**
   * Gera diagn√≥stico com IA
   */
  async function gerarDiagnosticoAI() {
    const btn = document.getElementById("btnGerarDiagnostico");
    const tipoAparelho = document.getElementById("tipoAparelho").value.trim();
    const marcaModelo = document.getElementById("marcaModelo").value.trim();
    const problemaRelatado = document
      .getElementById("problemaRelatado")
      .value.trim();
    const diagnosticoField = document.getElementById("diagnosticoTecnico");

    // Valida√ß√£o
    if (!tipoAparelho || !marcaModelo || !problemaRelatado) {
      alert(
        "Para gerar o diagn√≥stico, √© necess√°rio preencher: Tipo de Aparelho, Marca/Modelo e Problema Relatado."
      );
      return;
    }

    // Desabilita bot√£o durante processamento
    const textoOriginal = btn.textContent;
    btn.disabled = true;
    btn.textContent = "üß† Gerando...";

    try {
      console.log("ü§ñ Gerando diagn√≥stico com IA...");
      const resultado = await gerarDiagnosticoApi({
        tipoAparelho: tipoAparelho,
        marcaModelo: marcaModelo,
        problema: problemaRelatado,
      });

      if (resultado && resultado.diagnostico) {
        diagnosticoField.value = resultado.diagnostico;
        console.log("‚úÖ Diagn√≥stico gerado com sucesso!");
        alert("Pr√©-diagn√≥stico gerado com sucesso pela IA!");
      } else {
        throw new Error("Resposta da IA inv√°lida");
      }
    } catch (error) {
      console.error("‚ùå Erro ao gerar diagn√≥stico:", error);
      alert(
        "Erro ao gerar diagn√≥stico com IA. Tente novamente.\n\n" +
          (error.message || "Erro desconhecido")
      );
    } finally {
      // Reabilita bot√£o
      btn.disabled = false;
      btn.textContent = textoOriginal;
    }
  }

  /**
   * Exporta lista de OS
   */
  function exportarOS() {
    if (osFiltradas.length === 0) {
      alert("Nenhuma O.S para exportar.");
      return;
    }

    let csv =
      "N√∫mero,Cliente,Aparelho,Problema,Status,Prioridade,Data Cria√ß√£o,Prazo,Valor\n";

    osFiltradas.forEach((os) => {
      const dataCriacao = new Date(os.dataCriacao);
      const prazoLimite = new Date(dataCriacao);
      prazoLimite.setDate(prazoLimite.getDate() + (os.prazoEstimado || 3));

      csv += `"${os.numeroOS}","${os.cliente}","${os.marcaModelo}","${
        os.problemaRelatado
      }","${getStatusText(os.status)}","${getPrioridadeText(
        os.prioridade
      )}","${formatarData(os.dataCriacao)}","${formatarData(prazoLimite)}","${
        os.valorOrcamento || ""
      }"\n`;
    });

    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute(
      "download",
      `ordens_servico_${new Date().toISOString().split("T")[0]}.csv`
    );
    link.style.visibility = "hidden";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
  }

  // ============================
  // EVENTOS (movidos para dentro do DOMContentLoaded)
  // ============================

  // ============================
  // INICIALIZA√á√ÉO
  // ============================

  document.addEventListener("DOMContentLoaded", async function () {
    // Protege a p√°gina
    protegerPagina();

    // Atualiza informa√ß√µes do usu√°rio
    atualizarInfoUsuario();

    // Define elementos do DOM (agora que est√£o dispon√≠veis)
    searchInput = document.getElementById("searchInput");
    osTableBody = document.getElementById("osTableBody");
    pagination = document.getElementById("pagination");
    totalOS = document.getElementById("totalOS");
    osAguardando = document.getElementById("osAguardando");
    osEmReparo = document.getElementById("osEmReparo");
    osAtrasadas = document.getElementById("osAtrasadas");
    resultadosInfo = document.getElementById("resultadosInfo");

    // Carrega dados
    console.log("üîÑ Carregando dados iniciais...");
    await carregarOS();
    await carregarClientes();
    console.log(
      "‚úÖ Dados carregados - OS:",
      osEmMemoria.length,
      "Clientes:",
      clientesEmMemoria.length
    );

    // Aplica filtros iniciais
    aplicarFiltros();
    atualizarEstatisticas();

    // Configura event listeners (agora que os elementos existem)
    configurarEventListeners();

    console.log("‚úÖ P√°gina de O.S carregada!");
  });

  /**
   * Configura event listener do formul√°rio (deve ser chamado sempre que o modal √© aberto)
   */
  function configurarEventListenerFormulario() {
    const formOS = document.getElementById("formOS");
    if (!formOS) return;

    // Remove event listener anterior se existir
    const novoFormOS = formOS.cloneNode(true);
    formOS.parentNode.replaceChild(novoFormOS, formOS);

    // Adiciona o event listener ao novo formul√°rio
    novoFormOS.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const dados = Object.fromEntries(formData.entries());

      // Processar campos especiais antes da valida√ß√£o
      if (dados.valorOrcamento) {
        // Converter "R$ 9,99" para 9.99
        dados.valorOrcamento = dados.valorOrcamento
          .replace("R$ ", "") // Remove "R$ "
          .replace(".", "") // Remove pontos de milhares
          .replace(",", "."); // Converte v√≠rgula para ponto
        dados.valorOrcamento = parseFloat(dados.valorOrcamento) || 0;
      }

      // Valida√ß√£o
      const validacao = validarFormularioOS(dados);
      if (!validacao.valido) {
        alert("Erro na valida√ß√£o:\n" + validacao.erros.join("\n"));
        return;
      }

      const osId = document.getElementById("osId").value;

      console.log("üìù Processando formul√°rio - osId:", osId, "dados:", dados);

      if (osId) {
        console.log("üîÑ Atualizando OS existente:", osId);
        // Atualizar OS existente
        if (atualizarOS(osId, dados)) {
          alert("O.S atualizada com sucesso!");

          // Atualiza notifica√ß√µes se dispon√≠vel
          if (window.notificationManager) {
            window.notificationManager.atualizarContador();
          }

          fecharModal();
          aplicarFiltros();
          atualizarEstatisticas();
        } else {
          alert("Erro ao atualizar O.S. Tente novamente.");
        }
      } else {
        console.log("‚ûï Criando nova OS");
        // Adicionar nova OS
        const resultado = await adicionarOS(dados);
        console.log("Resultado da cria√ß√£o:", resultado);

        if (resultado) {
          alert("O.S criada com sucesso!");
          fecharModal();

          console.log("üîÑ Recarregando dados da API...");
          // Recarrega dados da API e reaplica filtros
          await carregarOS();
          console.log("‚úÖ Dados recarregados - Total OS:", osEmMemoria.length);

          aplicarFiltros();
          atualizarEstatisticas();
        } else {
          alert("Erro ao criar O.S. Tente novamente.");
        }
      }
    });

    // Formata√ß√£o autom√°tica de campos
    const valorOrcamento = novoFormOS.querySelector("#valorOrcamento");
    if (valorOrcamento) {
      valorOrcamento.addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        value = (parseInt(value) / 100).toFixed(2);
        value = value.replace(".", ",");
        value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        e.target.value = "R$ " + value;
      });
    }
  }

  /**
   * Configura todos os event listeners da p√°gina
   */
  async function configurarEventListeners() {
    // Evento de busca
    if (searchInput) {
      searchInput.addEventListener("input", aplicarFiltros);
    }

    // Eventos de filtros
    const filtroStatus = document.getElementById("filtroStatus");
    if (filtroStatus) {
      filtroStatus.addEventListener("change", aplicarFiltros);
    }

    const filtroPrioridade = document.getElementById("filtroPrioridade");
    if (filtroPrioridade) {
      filtroPrioridade.addEventListener("change", aplicarFiltros);
    }

    // Eventos de filtros de tempo
    document.querySelectorAll(".filter-btn[data-filtro]").forEach((btn) => {
      btn.addEventListener("click", function () {
        document
          .querySelectorAll(".filter-btn[data-filtro]")
          .forEach((b) => b.classList.remove("active"));
        this.classList.add("active");
        aplicarFiltros();
      });
    });

    // Fechar modal ao clicar fora
    document.querySelectorAll(".modal").forEach((modal) => {
      modal.addEventListener("click", function (e) {
        if (e.target === modal) {
          fecharModal();
        }
      });
    });
  }
</script>

<style>
  /* Estilos espec√≠ficos para a p√°gina de O.S */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: var(--bg-primary);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px var(--shadow-color);
    border: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .stat-icon.blue {
    background: #dbeafe;
    color: #1e3a8a;
  }
  .stat-icon.green {
    background: #d1fae5;
    color: #065f46;
  }
  .stat-icon.yellow {
    background: #fef3c7;
    color: #92400e;
  }
  .stat-icon.red {
    background: #fee2e2;
    color: #dc2626;
  }

  .stat-info h3 {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }

  .stat-info p {
    color: var(--text-secondary);
    margin: 5px 0 0 0;
    font-size: 14px;
  }

  .filters-section {
    background: var(--bg-primary);
    padding: 20px;
    border-radius: 12px;
    box-shadow: 0 2px 8px var(--shadow-color);
    border: 2px solid var(--border-color);
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 15px;
  }

  .filter-controls {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
  }

  .results-info {
    color: var(--text-secondary);
    font-size: 14px;
  }

  .os-section {
    background: var(--bg-primary);
    border-radius: 12px;
    padding: 25px;
    box-shadow: 0 2px 8px var(--shadow-color);
    border: 2px solid var(--border-color);
  }

  .table-container {
    overflow-x: auto;
  }

  .os-table {
    width: 100%;
    border-collapse: collapse;
  }

  .os-table thead {
    background: var(--bg-tertiary);
  }

  .os-table th {
    padding: 15px 12px;
    text-align: left;
    font-size: 13px;
    color: var(--text-primary);
    font-weight: 600;
    white-space: nowrap;
  }

  .os-table td {
    padding: 15px 12px;
    border-bottom: 1px solid var(--border-color);
    font-size: 14px;
  }

  .os-table tbody tr:hover {
    background: var(--bg-tertiary);
  }

  .aparelho-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .aparelho-icon {
    width: 30px;
    height: 30px;
    background: var(--primary-blue);
    color: white;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .problema-cell {
    max-width: 200px;
    word-wrap: break-word;
  }

  .status-badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }

  .status-badge.aguardando {
    background: #fef3c7;
    color: #92400e;
  }

  .status-badge.em_reparo {
    background: #dbeafe;
    color: #1e3a8a;
  }

  .status-badge.pronto {
    background: #d1fae5;
    color: #065f46;
  }

  .status-badge.entregue {
    background: #e5e7eb;
    color: #374151;
  }

  .status-badge.cancelado {
    background: #fee2e2;
    color: #dc2626;
  }

  .prioridade-badge {
    padding: 4px 10px;
    border-radius: 15px;
    font-size: 11px;
    font-weight: 600;
    display: inline-block;
  }

  .prioridade-badge.baixa {
    background: #f3f4f6;
    color: #6b7280;
  }

  .prioridade-badge.normal {
    background: #dbeafe;
    color: #1e3a8a;
  }

  .prioridade-badge.alta {
    background: #fef3c7;
    color: #92400e;
  }

  .prioridade-badge.urgente {
    background: #fee2e2;
    color: #dc2626;
  }

  .atrasada {
    color: var(--red) !important;
    font-weight: bold;
  }

  .os-details {
    padding: 20px 0;
  }

  .os-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e5e7eb;
  }

  .os-number {
    font-size: 24px;
    font-weight: 700;
    color: var(--dark-blue);
  }

  .os-status {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .os-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .detail-item.full-width {
    grid-column: 1 / -1;
  }

  .detail-item label {
    font-weight: 600;
    color: var(--gray-dark);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .detail-item span {
    color: var(--gray-dark);
    font-size: 14px;
  }

  .pagination {
    margin-top: 20px;
    display: flex;
    justify-content: center;
  }

  .pagination-controls {
    display: flex;
    gap: 5px;
  }

  .pagination-btn {
    padding: 8px 12px;
    border: 1px solid #e5e7eb;
    background: white;
    border-radius: 6px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s;
  }

  .pagination-btn:hover {
    background: var(--gray-light);
  }

  .pagination-btn.active {
    background: var(--primary-blue);
    color: white;
    border-color: var(--primary-blue);
  }

  .btn-delete {
    background: var(--red) !important;
    color: white !important;
  }

  .btn-delete:hover {
    opacity: 0.8;
  }

  .status-select {
    padding: 6px 8px;
    border: 1px solid #d1d5db;
    border-radius: 6px;
    background: white;
    font-size: 12px;
    font-weight: 500;
    color: var(--gray-dark);
    cursor: pointer;
    min-width: 110px;
    transition: all 0.2s ease;
  }

  .status-select:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
  }

  .status-select:hover {
    border-color: #9ca3af;
  }

  .status-select:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    background: #f9fafb;
  }

  /* Estilizar as op√ß√µes do select para parecer com badges */
  .status-select option[value="aguardando"] {
    background: #fef3c7;
    color: #92400e;
  }

  .status-select option[value="em_reparo"] {
    background: #dbeafe;
    color: #1e3a8a;
  }

  .status-select option[value="pronto"] {
    background: #d1fae5;
    color: #065f46;
  }

  .status-select option[value="entregue"] {
    background: #e5e7eb;
    color: #374151;
  }

  .status-select option[value="cancelado"] {
    background: #fee2e2;
    color: #dc2626;
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .filters-section {
      flex-direction: column;
      align-items: stretch;
    }

    .filter-controls {
      justify-content: center;
    }

    .os-table {
      font-size: 12px;
    }

    .os-table th,
    .os-table td {
      padding: 8px;
    }

    .status-select {
      min-width: 90px;
      font-size: 11px;
      padding: 4px 6px;
    }
  }
</style>
{% endblock %}

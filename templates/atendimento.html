{% extends "base.html" %} {% block title %}Atendimento - TechAI Assist{%
endblock %} {% set active_page = 'atendimento' %} {% block content %}
<div class="page-header">
  <h1>Atendimento</h1>
</div>

<!-- A√á√ïES R√ÅPIDAS -->
<div class="quick-actions">
  <div class="action-card" onclick="abrirNovaOS()">
    <div class="action-card-icon">üìù</div>
    <h3>Nova OS</h3>
    <p>Criar nova ordem de servi√ßo</p>
  </div>

  <div class="action-card" onclick="abrirNovoCliente()">
    <div class="action-card-icon">üë§</div>
    <h3>Novo Cliente</h3>
    <p>Cadastrar novo cliente</p>
  </div>

  <div class="action-card" onclick="consultarEstoque()">
    <div class="action-card-icon">üì¶</div>
    <h3>Consultar Estoque</h3>
    <p>Verificar disponibilidade de pe√ßas</p>
  </div>

  <div class="action-card" onclick="buscarCliente()">
    <div class="action-card-icon">üîç</div>
    <h3>Buscar Cliente</h3>
    <p>Pesquisar clientes cadastrados</p>
  </div>
</div>

<!-- TABELA DE OS PARA ATENDIMENTO -->
<div class="os-table-section">
  <div class="section-header">
    <h2>Ordens de Servi√ßo para Atendimento</h2>
    <div class="filter-buttons">
      <button class="filter-btn active" data-filter="todas">Todas</button>
      <button class="filter-btn" data-filter="aguardando">Aguardando</button>
      <button class="filter-btn" data-filter="em_reparo">Em Reparo</button>
      <button class="filter-btn" data-filter="pronto">Prontas</button>
    </div>
  </div>

  <div class="table-container">
    <table class="os-table" id="osTable">
      <thead>
        <tr>
          <th>OS</th>
          <th>Cliente</th>
          <th>Aparelho</th>
          <th>Problema</th>
          <th>Status</th>
          <th>Data</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="osTableBody">
        <!-- Dados ser√£o inseridos via JavaScript -->
      </tbody>
    </table>
  </div>
</div>
{% endblock %} {% block extra_body %}
<!-- MODAL NOVA OS -->
<div class="modal" id="modalNovaOS">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Nova Ordem de Servi√ßo</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>

    <form id="formNovaOS">
      <div class="form-group">
        <label for="clienteOS">Cliente *</label>
        <select id="clienteOS" name="clienteId" required>
          <option value="">Selecione o cliente...</option>
          <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="tipoAparelho">Tipo de Aparelho *</label>
          <select id="tipoAparelho" name="tipoAparelho" required>
            <option value="">Selecione...</option>
            <option value="smartphone">Smartphone</option>
            <option value="tablet">Tablet</option>
            <option value="notebook">Notebook</option>
            <option value="desktop">Desktop</option>
            <option value="outro">Outro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="marcaModelo">Marca/Modelo *</label>
          <input
            type="text"
            id="marcaModelo"
            name="marcaModelo"
            placeholder="Ex: iPhone 12 Pro"
            required
          />
        </div>
      </div>

      <div class="form-group">
        <label for="problemaRelatado">Problema Relatado *</label>
        <textarea
          id="problemaRelatado"
          name="problemaRelatado"
          rows="4"
          placeholder="Descreva o problema reportado pelo cliente"
          required
        ></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="prazoEstimado">Prazo Estimado (dias) *</label>
          <input
            type="number"
            id="prazoEstimado"
            name="prazoEstimado"
            value="3"
            min="1"
            required
          />
        </div>
        <div class="form-group">
          <label for="prioridade">Prioridade</label>
          <select id="prioridade" name="prioridade">
            <option value="normal">Normal</option>
            <option value="alta">Alta</option>
            <option value="urgente">Urgente</option>
          </select>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="fecharModal()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary">Criar OS</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL NOVO CLIENTE -->
<div class="modal" id="modalNovoCliente">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Novo Cliente</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>

    <form id="formNovoCliente">
      <div class="form-group">
        <label for="nomeCliente">Nome Completo *</label>
        <input
          type="text"
          id="nomeCliente"
          name="nome"
          placeholder="Nome do cliente"
          required
        />
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="cpfCnpjCliente">CPF/CNPJ *</label>
          <input
            type="text"
            id="cpfCnpjCliente"
            name="cpfCnpj"
            placeholder="000.000.000-00"
            required
          />
        </div>
        <div class="form-group">
          <label for="telefoneCliente">Telefone *</label>
          <input
            type="tel"
            id="telefoneCliente"
            name="telefone"
            placeholder="(00) 00000-0000"
            required
          />
        </div>
      </div>

      <div class="form-group">
        <label for="emailCliente">E-mail</label>
        <input
          type="email"
          id="emailCliente"
          name="email"
          placeholder="cliente@email.com"
        />
      </div>

      <div class="form-group">
        <label for="enderecoCliente">Endere√ßo</label>
        <input
          type="text"
          id="enderecoCliente"
          name="endereco"
          placeholder="Rua, n√∫mero, bairro"
        />
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="fecharModal()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary">Cadastrar Cliente</button>
      </div>
    </form>
  </div>
</div>

<!-- MODAL BUSCAR CLIENTE -->
<div class="modal" id="modalBuscarCliente">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Buscar Cliente</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>

    <div class="form-group">
      <input
        type="text"
        id="buscaCliente"
        placeholder="Digite nome, CPF ou telefone do cliente..."
      />
    </div>

    <div id="resultadosBusca" class="resultados-busca">
      <!-- Resultados ser√£o inseridos via JavaScript -->
    </div>
  </div>
</div>

<!-- MODAL VISUALIZAR CLIENTE -->
<div class="modal" id="modalVisualizarCliente">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Detalhes do Cliente</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>

    <div id="clienteDetalhesAtendimento">
      <!-- Detalhes ser√£o inseridos via JavaScript -->
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" onclick="fecharModal()">
        Fechar
      </button>
      <button
        type="button"
        class="btn btn-primary"
        onclick="verOSClienteAtual()"
      >
        Ver OS do Cliente
      </button>
    </div>
  </div>
</div>

<!-- MODAL VISUALIZAR O.S -->
<div class="modal" id="modalVisualizarOS">
  <div class="modal-content">
    <div class="modal-header">
      <h2>Detalhes da Ordem de Servi√ßo</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>

    <div id="osDetalhes">
      <!-- Detalhes ser√£o inseridos via JavaScript -->
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" onclick="fecharModal()">
        Fechar
      </button>
      <button type="button" class="btn btn-primary" onclick="editarOSAtual()">
        Editar
      </button>
    </div>
  </div>
</div>

<!-- MODAL CONSULTAR ESTOQUE -->
<div class="modal" id="modalConsultarEstoque">
  <div class="modal-content large-modal">
    <div class="modal-header">
      <h2>Consulta de Estoque</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>

    <div class="estoque-modal-content">
      <!-- CARDS DE ESTAT√çSTICAS -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon blue">üì¶</div>
          <div class="stat-info">
            <h3 id="modalTotalProdutos">0</h3>
            <p>Total de Produtos</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon green">üí∞</div>
          <div class="stat-info">
            <h3 id="modalValorTotal">R$ 0,00</h3>
            <p>Valor Total do Estoque</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon yellow">‚ö†Ô∏è</div>
          <div class="stat-info">
            <h3 id="modalEstoqueBaixo">0</h3>
            <p>Estoque Baixo</p>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-icon red">üö®</div>
          <div class="stat-info">
            <h3 id="modalEstoqueCritico">0</h3>
            <p>Estoque Cr√≠tico</p>
          </div>
        </div>
      </div>

      <!-- FILTROS -->
      <div class="filters-section">
        <div class="filter-controls">
          <select id="modalCategoryFilter" class="filter-btn">
            <option value="">Todas Categorias</option>
            <option value="Telas">Telas</option>
            <option value="Baterias">Baterias</option>
            <option value="C√¢meras">C√¢meras</option>
            <option value="Conectores">Conectores</option>
            <option value="Alto-falantes">Alto-falantes</option>
            <option value="Outros">Outros</option>
          </select>
          <button
            class="filter-btn active"
            data-filter="all"
            id="modalFilterAll"
          >
            Todos
          </button>
          <button class="filter-btn" data-filter="ok" id="modalFilterOk">
            Estoque OK
          </button>
          <button class="filter-btn" data-filter="baixo" id="modalFilterBaixo">
            Estoque Baixo
          </button>
          <button
            class="filter-btn"
            data-filter="critico"
            id="modalFilterCritico"
          >
            Cr√≠tico
          </button>
        </div>
        <div class="results-info">
          <span id="modalResultadosInfo">Mostrando 0 produtos</span>
        </div>
      </div>

      <!-- TABELA DE PRODUTOS -->
      <div class="table-container">
        <table class="products-table" id="modalProductsTable">
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Produto</th>
              <th>Categoria</th>
              <th>Qtd. Atual</th>
              <th>M√≠n.</th>
              <th>Pre√ßo Custo</th>
              <th>Valor Total</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody id="modalProductsTableBody">
            <!-- Dados ser√£o inseridos via JavaScript -->
          </tbody>
        </table>
      </div>
    </div>

    <div class="form-actions">
      <button type="button" class="btn btn-secondary" onclick="fecharModal()">
        Fechar
      </button>
      <button
        type="button"
        class="btn btn-primary"
        onclick="irParaEstoqueCompleto()"
      >
        Ver Estoque Completo
      </button>
    </div>
  </div>
</div>

<!-- MODAL EDITAR O.S -->
<div class="modal" id="modalEditarOS">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalEditarTitle">Editar Ordem de Servi√ßo</h2>
      <button class="close-modal" onclick="fecharModal()">√ó</button>
    </div>

    <form id="formEditarOS">
      <input type="hidden" id="editOsId" name="id" />

      <div class="form-row">
        <div class="form-group">
          <label for="editNumeroOS">N√∫mero da O.S</label>
          <input
            type="text"
            id="editNumeroOS"
            name="numeroOS"
            placeholder="Auto-gerado"
            readonly
          />
        </div>
        <div class="form-group">
          <label for="editPrioridade">Prioridade *</label>
          <select id="editPrioridade" name="prioridade" required>
            <option value="">Selecione...</option>
            <option value="baixa">Baixa</option>
            <option value="normal" selected>Normal</option>
            <option value="alta">Alta</option>
            <option value="urgente">Urgente</option>
          </select>
        </div>
      </div>

      <div class="form-group">
        <label for="editCliente">Cliente *</label>
        <select id="editCliente" name="clienteId" required>
          <option value="">Selecione o cliente...</option>
          <!-- Op√ß√µes ser√£o preenchidas via JavaScript -->
        </select>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="editTipoAparelho">Tipo de Aparelho *</label>
          <select id="editTipoAparelho" name="tipoAparelho" required>
            <option value="">Selecione...</option>
            <option value="smartphone">Smartphone</option>
            <option value="tablet">Tablet</option>
            <option value="notebook">Notebook</option>
            <option value="desktop">Desktop</option>
            <option value="outro">Outro</option>
          </select>
        </div>
        <div class="form-group">
          <label for="editMarcaModelo">Marca/Modelo *</label>
          <input
            type="text"
            id="editMarcaModelo"
            name="marcaModelo"
            placeholder="Ex: iPhone 12 Pro"
            required
          />
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="editImeiSerial">IMEI/Serial</label>
          <input
            type="text"
            id="editImeiSerial"
            name="imeiSerial"
            placeholder="N√∫mero de s√©rie"
          />
        </div>
        <div class="form-group">
          <label for="editCorAparelho">Cor</label>
          <input
            type="text"
            id="editCorAparelho"
            name="corAparelho"
            placeholder="Ex: Preto, Branco"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="editProblemaRelatado">Problema Relatado *</label>
        <textarea
          id="editProblemaRelatado"
          name="problemaRelatado"
          rows="4"
          placeholder="Descreva o problema reportado pelo cliente"
          required
        ></textarea>
      </div>

      <div class="form-group">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
          "
        >
          <label for="editDiagnosticoTecnico">Pr√©-diagn√≥stico</label>
          <button
            type="button"
            class="btn btn-secondary"
            id="btnGerarDiagnosticoEdit"
            onclick="gerarDiagnosticoAIEdit()"
            style="font-size: 12px; padding: 6px 12px"
          >
            üß† Diagn√≥stico Preview
          </button>
        </div>
        <textarea
          id="editDiagnosticoTecnico"
          name="diagnosticoTecnico"
          rows="3"
          placeholder="Pr√©-diagn√≥stico gerado pela IA ou realizado pelo t√©cnico"
        ></textarea>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="editPrazoEstimado">Prazo Estimado (dias) *</label>
          <input
            type="number"
            id="editPrazoEstimado"
            name="prazoEstimado"
            value="3"
            min="1"
            required
          />
        </div>
        <div class="form-group">
          <label for="editValorOrcamento">Valor do Or√ßamento</label>
          <input
            type="text"
            id="editValorOrcamento"
            name="valorOrcamento"
            placeholder="R$ 0,00"
          />
        </div>
      </div>

      <div class="form-group">
        <label for="editObservacoes">Observa√ß√µes</label>
        <textarea
          id="editObservacoes"
          name="observacoes"
          rows="3"
          placeholder="Informa√ß√µes adicionais sobre a O.S"
        ></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-secondary" onclick="fecharModal()">
          Cancelar
        </button>
        <button type="submit" class="btn btn-primary" id="submitEditarBtn">
          Atualizar O.S
        </button>
      </div>
    </form>
  </div>
</div>
{% endblock %} {% block extra_scripts %}
<script src="/js/clientes.js"></script>
<script src="/js/estoque.js"></script>

<script>
  // ========================================
  // SCRIPT DA P√ÅGINA DE ATENDIMENTO
  // ========================================

  // Array que mant√©m as OS em mem√≥ria
  let osEmMemoria = [];

  // Estado do filtro atual
  let filtroStatusAtual = "todas";

  // Elementos do DOM (ser√£o definidos dentro do DOMContentLoaded)
  let searchInput, osTableBody;

  // Vari√°vel para armazenar o cliente atual sendo visualizado
  let clienteAtual = null;

  // ============================
  // FUN√á√ïES DE DADOS (usando API)
  // ============================

  /**
   * Carrega todas as OS da API
   */
  async function carregarOS() {
    try {
      const os = await listarOSApi();
      osEmMemoria = os || [];
      console.log("‚úÖ OS carregadas da API:", osEmMemoria.length);
      return osEmMemoria;
    } catch (e) {
      console.error("‚ùå Erro ao carregar OS:", e);
      osEmMemoria = [];
      return osEmMemoria;
    }
  }

  /**
   * Adiciona uma nova OS via API
   */
  async function adicionarOS(os) {
    try {
      console.log("üìù Criando OS via API:", os);
      const criado = await criarOSApi(os);
      console.log("‚úÖ OS criada:", criado);

      // Adiciona ao array local tamb√©m
      osEmMemoria.push(criado);
      return criado;
    } catch (e) {
      console.error("‚ùå Erro ao criar OS:", e);
      throw e;
    }
  }

  /**
   * Gera pr√≥ximo n√∫mero de OS
   */
  function gerarProximoNumeroOS() {
    const numerosExistentes = osEmMemoria.map((os) => {
      const numero = os.numeroOS.replace("#", "").replace("OS", "");
      return parseInt(numero) || 0;
    });

    const proximoNumero = Math.max(...numerosExistentes, 0) + 1;
    return `#OS${proximoNumero.toString().padStart(4, "0")}`;
  }

  /**
   * Busca OS por termo
   */
  function buscarOS(termo) {
    if (!termo || termo.trim() === "") {
      return osEmMemoria.slice(0, 10); // Mostra apenas as 10 mais recentes
    }

    const termoLower = termo.toLowerCase();

    return osEmMemoria.filter((os) => {
      return (
        os.numeroOS.toLowerCase().includes(termoLower) ||
        os.clienteNome?.toLowerCase().includes(termoLower) ||
        os.marcaModelo.toLowerCase().includes(termoLower) ||
        os.problemaRelatado.toLowerCase().includes(termoLower)
      );
    });
  }

  /**
   * Valida formul√°rio de OS (vers√£o simplificada para atendimento)
   */
  function validarFormularioOS(dados) {
    const erros = [];

    if (!dados.clienteId || dados.clienteId.trim() === "") {
      erros.push("Cliente √© obrigat√≥rio");
    }

    if (!dados.tipoAparelho || dados.tipoAparelho.trim() === "") {
      erros.push("Tipo de aparelho √© obrigat√≥rio");
    }

    if (!dados.marcaModelo || dados.marcaModelo.trim() === "") {
      erros.push("Marca/Modelo √© obrigat√≥rio");
    }

    if (!dados.problemaRelatado || dados.problemaRelatado.trim() === "") {
      erros.push("Problema relatado √© obrigat√≥rio");
    }

    if (!dados.prazoEstimado || dados.prazoEstimado < 1) {
      erros.push("Prazo estimado deve ser pelo menos 1 dia");
    }

    return {
      valido: erros.length === 0,
      erros: erros,
    };
  }

  // ============================
  // FUN√á√ïES DE INTERFACE
  // ============================

  /**
   * Renderiza a tabela de OS
   */
  function renderizarTabelaOS(filtroStatus = "todas") {
    let osFiltradas = osEmMemoria.sort(
      (a, b) => new Date(b.dataCriacao) - new Date(a.dataCriacao)
    );

    // Aplica filtro por status
    if (filtroStatus !== "todas") {
      if (filtroStatus === "pronto") {
        // "Prontas" inclui apenas status "pronto" (n√£o entregue/cancelado)
        osFiltradas = osFiltradas.filter((os) => os.status === "pronto");
      } else {
        osFiltradas = osFiltradas.filter((os) => os.status === filtroStatus);
      }
    }

    const osRecentes = osFiltradas.slice(0, 10);

    osTableBody.innerHTML = "";

    if (osRecentes.length === 0) {
      osTableBody.innerHTML = `
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 40px; color: var(--gray-medium);">
                            <div style="font-size: 48px; margin-bottom: 20px;">üìã</div>
                            <div>Nenhuma ordem de servi√ßo encontrada</div>
                            <div style="font-size: 14px; margin-top: 10px;">Crie sua primeira O.S!</div>
                        </td>
                    </tr>
                `;
      return;
    }

    osRecentes.forEach((os) => {
      const row = document.createElement("tr");
      const dataCriacao = new Date(os.dataCriacao);
      const prazoLimite = new Date(dataCriacao);
      prazoLimite.setDate(prazoLimite.getDate() + (os.prazoEstimado || 3));
      const hoje = new Date();
      const atrasada =
        hoje > prazoLimite &&
        os.status !== "entregue" &&
        os.status !== "cancelado";

      row.innerHTML = `
                    <td><strong>${os.numeroOS}</strong></td>
                    <td>${os.clienteNome}</td>
                    <td>
                        <div class="aparelho-info">
                            <div class="aparelho-icon">üì±</div>
                            <span>${os.marcaModelo}</span>
                        </div>
                    </td>
                    <td class="problema-cell">${os.problemaRelatado.substring(
                      0,
                      50
                    )}${os.problemaRelatado.length > 50 ? "..." : ""}</td>
                    <td><span class="status-badge ${os.status}">${getStatusText(
        os.status
      )}</span></td>
                    <td>${formatarData(os.dataCriacao)}</td>
                    <td>
                        <div class="actions-cell">
                            <button class="action-btn-small btn-view" onclick="visualizarOS('${
                              os.id
                            }')" title="Visualizar">
                                üëÅÔ∏è
                            </button>
                            <button class="action-btn-small btn-edit" onclick="editarOS('${
                              os.id
                            }')" title="Editar">
                                ‚úèÔ∏è
                            </button>
                        </div>
                    </td>
                `;
      osTableBody.appendChild(row);
    });
  }

  /**
   * Retorna texto do status
   */
  function getStatusText(status) {
    const statusMap = {
      aguardando: "Aguardando",
      em_reparo: "Em Reparo",
      pronto: "Pronto",
      entregue: "Entregue",
      cancelado: "Cancelado",
    };
    return statusMap[status] || status;
  }

  // ============================
  // FUN√á√ïES DE A√á√ïES R√ÅPIDAS
  // ============================

  /**
   * Abre modal para nova OS
   */
  function abrirNovaOS() {
    const modal = document.getElementById("modalNovaOS");
    const selectCliente = document.getElementById("clienteOS");

    // Carrega clientes no select
    selectCliente.innerHTML =
      '<option value="">Selecione o cliente...</option>';
    clientesEmMemoria.forEach((cliente) => {
      const option = document.createElement("option");
      option.value = cliente.id;
      option.textContent = cliente.nome;
      selectCliente.appendChild(option);
    });

    modal.classList.add("active");
  }

  /**
   * Abre modal para novo cliente
   */
  function abrirNovoCliente() {
    const modal = document.getElementById("modalNovoCliente");
    modal.classList.add("active");
  }

  /**
   * Abre modal para consultar estoque
   */
  async function consultarEstoque() {
    console.log("üì¶ Abrindo modal de consulta de estoque...");

    // Carrega produtos se ainda n√£o foram carregados
    if (!produtosEmMemoria || produtosEmMemoria.length === 0) {
      await carregarProdutos();
    }

    // Abre o modal
    const modal = document.getElementById("modalConsultarEstoque");
    modal.classList.add("active");

    // Renderiza os dados no modal
    renderizarEstoqueModal();
  }

  /**
   * Renderiza dados do estoque no modal
   */
  function renderizarEstoqueModal() {
    atualizarEstatisticasModal();
    aplicarFiltrosModal();
  }

  /**
   * Atualiza estat√≠sticas no modal
   */
  function atualizarEstatisticasModal() {
    const total = produtosEmMemoria.length;
    const valorTotal = produtosEmMemoria.reduce(
      (total, p) => total + p.quantidade * p.precoCusto,
      0
    );
    const estoqueBaixo = produtosEmMemoria.filter(
      (p) => calcularStatusEstoque(p.quantidade, p.estoqueMinimo) === "baixo"
    ).length;
    const estoqueCritico = produtosEmMemoria.filter(
      (p) => calcularStatusEstoque(p.quantidade, p.estoqueMinimo) === "critico"
    ).length;

    document.getElementById("modalTotalProdutos").textContent = total;
    document.getElementById(
      "modalValorTotal"
    ).textContent = `R$ ${valorTotal.toLocaleString("pt-BR", {
      minimumFractionDigits: 2,
    })}`;
    document.getElementById("modalEstoqueBaixo").textContent = estoqueBaixo;
    document.getElementById("modalEstoqueCritico").textContent = estoqueCritico;
  }

  /**
   * Aplica filtros no modal
   */
  function aplicarFiltrosModal() {
    const filtroCategoria = document.getElementById(
      "modalCategoryFilter"
    ).value;
    const filtroStatus =
      document
        .querySelector("#modalConsultarEstoque .filter-btn.active")
        ?.getAttribute("data-filter") || "all";

    // Busca por termo (se houvesse campo de busca, mas n√£o h√° no modal simples)
    let produtos = [...produtosEmMemoria];

    // Filtro por categoria
    if (filtroCategoria) {
      produtos = produtos.filter(
        (p) => p.categoria.toLowerCase() === filtroCategoria.toLowerCase()
      );
    }

    // Filtro por status
    if (filtroStatus !== "all") {
      produtos = produtos.filter((p) => {
        const status = calcularStatusEstoque(p.quantidade, p.estoqueMinimo);
        return status === filtroStatus;
      });
    }

    // Atualiza contador
    const resultadosInfo = document.getElementById("modalResultadosInfo");
    if (resultadosInfo) {
      resultadosInfo.textContent = `Mostrando ${produtos.length} produto${
        produtos.length !== 1 ? "s" : ""
      }`;
    }

    // Renderiza tabela
    renderizarTabelaModal(produtos);
  }

  /**
   * Renderiza tabela de produtos no modal
   */
  function renderizarTabelaModal(produtos) {
    const tbody = document.getElementById("modalProductsTableBody");
    tbody.innerHTML = "";

    if (produtos.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="8" style="text-align: center; padding: 40px; color: var(--gray-medium);">
            <div style="font-size: 48px; margin-bottom: 20px;">üì¶</div>
            <div>Nenhum produto encontrado</div>
            <div style="font-size: 14px; margin-top: 10px;">Ajuste os filtros para ver produtos.</div>
          </td>
        </tr>
      `;
      return;
    }

    produtos.forEach((produto) => {
      const row = document.createElement("tr");
      const status = calcularStatusEstoque(
        produto.quantidade,
        produto.estoqueMinimo
      );
      const valorTotal = produto.quantidade * produto.precoCusto;

      row.innerHTML = `
        <td><strong>${produto.codigo}</strong></td>
        <td>
          <div class="product-info">
            <div class="product-img">${getIconeCategoria(
              produto.categoria
            )}</div>
            <div>
              <div class="product-name">${produto.nome}</div>
              ${
                produto.descricao
                  ? `<div class="product-desc">${produto.descricao.substring(
                      0,
                      30
                    )}${produto.descricao.length > 30 ? "..." : ""}</div>`
                  : ""
              }
            </div>
          </div>
        </td>
        <td>${produto.categoria}</td>
        <td class="quantidade-cell ${
          status === "critico" ? "critico" : status === "baixo" ? "baixo" : ""
        }">
          <strong>${produto.quantidade}</strong>
        </td>
        <td>${produto.estoqueMinimo}</td>
        <td>R$ ${produto.precoCusto.toLocaleString("pt-BR", {
          minimumFractionDigits: 2,
        })}</td>
        <td>R$ ${valorTotal.toLocaleString("pt-BR", {
          minimumFractionDigits: 2,
        })}</td>
        <td><span class="stock-badge ${status}">${getStatusText(
        status
      )}</span></td>
      `;
      tbody.appendChild(row);
    });
  }

  /**
   * Redireciona para a p√°gina completa de estoque
   */
  function irParaEstoqueCompleto() {
    window.location.href = "/estoque";
  }

  /**
   * Abre modal para buscar cliente
   */
  function buscarCliente() {
    const modal = document.getElementById("modalBuscarCliente");
    modal.classList.add("active");
  }

  /**
   * Visualiza OS - abre modal na mesma p√°gina
   */
  function visualizarOS(id) {
    const os = osEmMemoria.find((o) => o.id === parseInt(id));
    if (!os) {
      console.error("OS n√£o encontrada:", id);
      return;
    }

    osAtual = os;
    const modal = document.getElementById("modalVisualizarOS");
    const detalhes = document.getElementById("osDetalhes");

    const dataCriacao = new Date(os.dataCriacao);
    const prazoLimite = new Date(dataCriacao);
    prazoLimite.setDate(prazoLimite.getDate() + (os.prazoEstimado || 3));
    const hoje = new Date();
    const atrasada =
      hoje > prazoLimite &&
      os.status !== "entregue" &&
      os.status !== "cancelado";

    detalhes.innerHTML = `
                <div class="os-details">
                    <div class="os-header">
                        <div class="os-number">${os.numeroOS}</div>
                        <div class="os-status">
                            <span class="status-badge ${
                              os.status
                            }">${getStatusText(os.status)}</span>
                            <span class="prioridade-badge ${
                              os.prioridade || "normal"
                            }">${getPrioridadeText(
      os.prioridade || "normal"
    )}</span>
                        </div>
                    </div>

                    <div class="os-details-grid">
                        <div class="detail-item">
                            <label>Cliente:</label>
                            <span>${os.clienteNome}</span>
                        </div>
                        <div class="detail-item">
                            <label>Tipo de Aparelho:</label>
                            <span>${os.tipoAparelho}</span>
                        </div>
                        <div class="detail-item">
                            <label>Marca/Modelo:</label>
                            <span>${os.marcaModelo}</span>
                        </div>
                        <div class="detail-item">
                            <label>IMEI/Serial:</label>
                            <span>${os.imeiSerial || "N√£o informado"}</span>
                        </div>
                        <div class="detail-item">
                            <label>Cor:</label>
                            <span>${os.corAparelho || "N√£o informado"}</span>
                        </div>
                        <div class="detail-item">
                            <label>Data de Cria√ß√£o:</label>
                            <span>${formatarDataHora(os.dataCriacao)}</span>
                        </div>
                        <div class="detail-item">
                            <label>Prazo Estimado:</label>
                            <span>${os.prazoEstimado} dias</span>
                        </div>
                        <div class="detail-item">
                            <label>Prazo Limite:</label>
                            <span class="${
                              atrasada ? "atrasada" : ""
                            }">${formatarData(prazoLimite)}</span>
                        </div>
                        <div class="detail-item">
                            <label>Valor do Or√ßamento:</label>
                            <span>${
                              os.valorOrcamento
                                ? "R$ " +
                                  parseFloat(os.valorOrcamento).toFixed(2)
                                : "N√£o informado"
                            }</span>
                        </div>
                        <div class="detail-item full-width">
                            <label>Problema Relatado:</label>
                            <span>${os.problemaRelatado}</span>
                        </div>
                        ${
                          os.diagnosticoTecnico
                            ? `
                        <div class="detail-item full-width">
                            <label>Diagn√≥stico T√©cnico:</label>
                            <span>${os.diagnosticoTecnico}</span>
                        </div>
                        `
                            : ""
                        }
                        ${
                          os.observacoes
                            ? `
                        <div class="detail-item full-width">
                            <label>Observa√ß√µes:</label>
                            <span>${os.observacoes}</span>
                        </div>
                        `
                            : ""
                        }
                    </div>
                </div>
            `;

    modal.classList.add("active");
  }

  /**
   * Edita OS - abre modal na mesma p√°gina
   */
  function editarOS(id) {
    const os = osEmMemoria.find((o) => o.id === parseInt(id));
    if (!os) {
      console.error("OS n√£o encontrada:", id);
      return;
    }

    const modal = document.getElementById("modalEditarOS");
    const modalTitle = document.getElementById("modalEditarTitle");

    modalTitle.textContent = "Editar Ordem de Servi√ßo";

    // Preenche o formul√°rio com os dados da OS
    preencherFormularioEdicao(os);

    // Carrega clientes no select
    carregarClientesSelectEdicao();

    // Configura event listener do formul√°rio
    configurarEventListenerFormularioEdicao();

    modal.classList.add("active");
  }

  /**
   * Edita a OS atual (do modal de visualiza√ß√£o)
   */
  function editarOSAtual() {
    if (osAtual) {
      fecharModal();
      setTimeout(() => {
        editarOS(osAtual.id);
      }, 300);
    }
  }

  // Vari√°vel para armazenar a OS atual sendo visualizada
  let osAtual = null;

  // ============================
  // FUN√á√ïES AUXILIARES PARA MODAIS
  // ============================

  /**
   * Retorna texto da prioridade
   */
  function getPrioridadeText(prioridade) {
    const prioridadeMap = {
      baixa: "Baixa",
      normal: "Normal",
      alta: "Alta",
      urgente: "Urgente",
    };
    return prioridadeMap[prioridade] || "Normal";
  }

  /**
   * Formata data para exibi√ß√£o
   */
  function formatarData(data) {
    if (!data) return "N/A";
    const d = new Date(data);
    return d.toLocaleDateString("pt-BR");
  }

  /**
   * Formata data e hora para exibi√ß√£o
   */
  function formatarDataHora(data) {
    if (!data) return "N/A";
    const d = new Date(data);
    return d.toLocaleString("pt-BR");
  }

  /**
   * Carrega clientes no select do modal de edi√ß√£o
   */
  function carregarClientesSelectEdicao() {
    const selectCliente = document.getElementById("editCliente");
    selectCliente.innerHTML =
      '<option value="">Selecione o cliente...</option>';

    clientesEmMemoria.forEach((cliente) => {
      const option = document.createElement("option");
      option.value = cliente.id;
      option.textContent = cliente.nome;
      selectCliente.appendChild(option);
    });
  }

  /**
   * Preenche formul√°rio de edi√ß√£o com dados da OS
   */
  function preencherFormularioEdicao(os) {
    document.getElementById("editOsId").value = os.id;
    document.getElementById("editNumeroOS").value = os.numeroOS;
    document.getElementById("editPrioridade").value = os.prioridade || "normal";
    document.getElementById("editCliente").value = os.clienteId;
    document.getElementById("editTipoAparelho").value = os.tipoAparelho;
    document.getElementById("editMarcaModelo").value = os.marcaModelo;
    document.getElementById("editImeiSerial").value = os.imeiSerial || "";
    document.getElementById("editCorAparelho").value = os.corAparelho || "";
    document.getElementById("editProblemaRelatado").value = os.problemaRelatado;
    document.getElementById("editDiagnosticoTecnico").value =
      os.diagnosticoTecnico || "";
    document.getElementById("editPrazoEstimado").value = os.prazoEstimado || 3;
    document.getElementById("editValorOrcamento").value =
      os.valorOrcamento || "";
    document.getElementById("editObservacoes").value = os.observacoes || "";
  }

  /**
   * Atualiza uma OS existente via API
   */
  async function atualizarOS(id, dadosAtualizados) {
    try {
      const atualizado = await atualizarOSApi(id, dadosAtualizados);

      // Atualiza no array local
      const indice = osEmMemoria.findIndex((o) => o.id === parseInt(id));
      if (indice !== -1) {
        osEmMemoria[indice] = atualizado;
      }

      console.log("‚úÖ OS atualizada:", atualizado.numeroOS);
      return true;
    } catch (e) {
      console.error("‚ùå Erro ao atualizar OS:", e);
      throw e;
    }
  }

  /**
   * Gera diagn√≥stico com IA para edi√ß√£o
   */
  async function gerarDiagnosticoAIEdit() {
    const btn = document.getElementById("btnGerarDiagnosticoEdit");
    const tipoAparelho = document
      .getElementById("editTipoAparelho")
      .value.trim();
    const marcaModelo = document.getElementById("editMarcaModelo").value.trim();
    const problemaRelatado = document
      .getElementById("editProblemaRelatado")
      .value.trim();
    const diagnosticoField = document.getElementById("editDiagnosticoTecnico");

    // Valida√ß√£o
    if (!tipoAparelho || !marcaModelo || !problemaRelatado) {
      alert(
        "Para gerar o diagn√≥stico, √© necess√°rio preencher: Tipo de Aparelho, Marca/Modelo e Problema Relatado."
      );
      return;
    }

    // Desabilita bot√£o durante processamento
    const textoOriginal = btn.textContent;
    btn.disabled = true;
    btn.textContent = "üß† Gerando...";

    try {
      console.log("ü§ñ Gerando diagn√≥stico com IA...");
      const resultado = await gerarDiagnosticoApi({
        tipoAparelho: tipoAparelho,
        marcaModelo: marcaModelo,
        problema: problemaRelatado,
      });

      if (resultado && resultado.diagnostico) {
        diagnosticoField.value = resultado.diagnostico;
        console.log("‚úÖ Diagn√≥stico gerado com sucesso!");
        alert("Pr√©-diagn√≥stico gerado com sucesso pela IA!");
      } else {
        throw new Error("Resposta da IA inv√°lida");
      }
    } catch (error) {
      console.error("‚ùå Erro ao gerar diagn√≥stico:", error);
      alert(
        "Erro ao gerar diagn√≥stico com IA. Tente novamente.\n\n" +
          (error.message || "Erro desconhecido")
      );
    } finally {
      // Reabilita bot√£o
      btn.disabled = false;
      btn.textContent = textoOriginal;
    }
  }

  /**
   * Configura event listener do formul√°rio de edi√ß√£o
   */
  function configurarEventListenerFormularioEdicao() {
    const formEditarOS = document.getElementById("formEditarOS");
    if (!formEditarOS) return;

    // Remove event listener anterior se existir
    const novoFormEditarOS = formEditarOS.cloneNode(true);
    formEditarOS.parentNode.replaceChild(novoFormEditarOS, formEditarOS);

    // Adiciona o event listener ao novo formul√°rio
    novoFormEditarOS.addEventListener("submit", async function (e) {
      e.preventDefault();

      const formData = new FormData(this);
      const dados = Object.fromEntries(formData.entries());

      // Processar campos especiais antes da valida√ß√£o
      if (dados.valorOrcamento) {
        // Converter "R$ 9,99" para 9.99
        dados.valorOrcamento = dados.valorOrcamento
          .replace("R$ ", "") // Remove "R$ "
          .replace(".", "") // Remove pontos de milhares
          .replace(",", "."); // Converte v√≠rgula para ponto
        dados.valorOrcamento = parseFloat(dados.valorOrcamento) || 0;
      }

      // Valida√ß√£o
      const validacao = validarFormularioOS(dados);
      if (!validacao.valido) {
        alert("Erro na valida√ß√£o:\n" + validacao.erros.join("\n"));
        return;
      }

      const osId = document.getElementById("editOsId").value;

      console.log("üîÑ Atualizando OS - ID:", osId, "dados:", dados);

      if (atualizarOS(osId, dados)) {
        alert("O.S atualizada com sucesso!");

        // Atualiza notifica√ß√µes se dispon√≠vel
        if (window.notificationManager) {
          window.notificationManager.atualizarContador();
        }

        fecharModal();
        renderizarTabelaOS(filtroStatusAtual);
      } else {
        alert("Erro ao atualizar O.S. Tente novamente.");
      }
    });

    // Formata√ß√£o autom√°tica de campos
    const valorOrcamento = novoFormEditarOS.querySelector(
      "#editValorOrcamento"
    );
    if (valorOrcamento) {
      valorOrcamento.addEventListener("input", function (e) {
        let value = e.target.value.replace(/\D/g, "");
        value = (parseInt(value) / 100).toFixed(2);
        value = value.replace(".", ",");
        value = value.replace(/(\d)(?=(\d{3})+(?!\d))/g, "$1.");
        e.target.value = "R$ " + value;
      });
    }
  }

  /**
   * Visualiza detalhes do cliente
   */
  function visualizarCliente(id) {
    const cliente = clientesEmMemoria.find((c) => c.id === parseInt(id));
    if (!cliente) return;

    clienteAtual = cliente;
    const modal = document.getElementById("modalVisualizarCliente");
    const detalhes = document.getElementById("clienteDetalhesAtendimento");

    detalhes.innerHTML = `
      <div class="client-details">
        <div class="client-header">
          <div class="client-avatar-large">${cliente.nome
            .charAt(0)
            .toUpperCase()}</div>
          <div class="client-info-large">
            <h3>${cliente.nome}</h3>
            <p class="client-type">${
              cliente.tipoPessoa === "pessoa_juridica"
                ? "Pessoa Jur√≠dica"
                : "Pessoa F√≠sica"
            }</p>
          </div>
        </div>

        <div class="client-details-grid">
          <div class="detail-item">
            <label>CPF/CNPJ:</label>
            <span>${cliente.cpfCnpj}</span>
          </div>
          <div class="detail-item">
            <label>Telefone:</label>
            <span>${cliente.telefone || "N√£o informado"}</span>
          </div>
          <div class="detail-item">
            <label>E-mail:</label>
            <span>${cliente.email || "N√£o informado"}</span>
          </div>
          <div class="detail-item">
            <label>Endere√ßo:</label>
            <span>${cliente.endereco || "N√£o informado"}</span>
          </div>
          <div class="detail-item">
            <label>Status:</label>
            <span class="status-badge ${cliente.status || "ativo"}">${
      cliente.status || "Ativo"
    }</span>
          </div>
          <div class="detail-item">
            <label>Data de Cadastro:</label>
            <span>${formatarDataHora(cliente.dataCadastro)}</span>
          </div>
          ${
            cliente.observacoes
              ? `
          <div class="detail-item full-width">
            <label>Observa√ß√µes:</label>
            <span>${cliente.observacoes}</span>
          </div>
          `
              : ""
          }
        </div>
      </div>
    `;

    modal.classList.add("active");
  }

  /**
   * Seleciona o cliente atual (do modal de visualiza√ß√£o)
   */
  function selecionarClienteAtual() {
    if (clienteAtual) {
      selecionarCliente(clienteAtual.id);
    }
  }

  /**
   * Ver OS do cliente atual
   */
  function verOSClienteAtual() {
    if (clienteAtual) {
      window.location.href = `/os?search=${encodeURIComponent(
        clienteAtual.nome
      )}`;
    }
  }

  /**
   * Fecha todos os modais
   */
  function fecharModal() {
    document.querySelectorAll(".modal").forEach((modal) => {
      modal.classList.remove("active");
    });
  }

  // ============================
  // EVENTOS (movidos para dentro do DOMContentLoaded)
  // ============================

  // ============================
  // INICIALIZA√á√ÉO
  // ============================

  document.addEventListener("DOMContentLoaded", async function () {
    // Protege a p√°gina
    protegerPagina();

    // Atualiza informa√ß√µes do usu√°rio
    atualizarInfoUsuario();

    // Define elementos do DOM (agora que est√£o dispon√≠veis)
    searchInput = document.getElementById("searchInput");
    osTableBody = document.getElementById("osTableBody");
    // Elementos espec√≠ficos do dashboard removidos - n√£o existem nesta p√°gina

    // Carrega dados (espera pelas chamadas ass√≠ncronas)
    await carregarOS(); // Agora usa API tamb√©m
    await carregarClientes(); // Espera carregar clientes da API
    await carregarProdutos(); // Espera carregar produtos da API

    // Renderiza interface ap√≥s os dados serem carregados
    renderizarTabelaOS(filtroStatusAtual);

    // Configura event listeners (agora que os elementos existem)
    configurarEventListeners();

    console.log("‚úÖ P√°gina de atendimento carregada!");
    console.log(
      "üìä Dados carregados - OS:",
      osEmMemoria.length,
      "Clientes:",
      clientesEmMemoria.length,
      "Produtos:",
      produtosEmMemoria.length
    );
  });

  /**
   * Configura todos os event listeners da p√°gina
   */
  function configurarEventListeners() {
    // Evento de busca
    if (searchInput) {
      searchInput.addEventListener("input", function (e) {
        const termo = e.target.value.trim();
        if (termo) {
          const resultados = buscarOS(termo);
          renderizarTabelaOS(filtroStatusAtual);
        } else {
          renderizarTabelaOS(filtroStatusAtual);
        }
      });
    }

    // Evento do formul√°rio de nova OS
    const formNovaOS = document.getElementById("formNovaOS");
    if (formNovaOS) {
      formNovaOS.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const dados = Object.fromEntries(formData.entries());

        // Processar campos especiais antes da valida√ß√£o
        if (dados.valorOrcamento) {
          // Converter "R$ 9,99" para 9.99
          dados.valorOrcamento = dados.valorOrcamento
            .replace("R$ ", "") // Remove "R$ "
            .replace(".", "") // Remove pontos de milhares
            .replace(",", "."); // Converte v√≠rgula para ponto
          dados.valorOrcamento = parseFloat(dados.valorOrcamento) || 0;
        }

        // Valida√ß√£o
        const validacao = validarFormularioOS(dados);
        if (!validacao.valido) {
          alert("Erro na valida√ß√£o:\n" + validacao.erros.join("\n"));
          return;
        }

        console.log("üìù Criando nova OS - dados:", dados);

        // Adicionar nova OS
        const resultado = await adicionarOS(dados);
        console.log("Resultado da cria√ß√£o:", resultado);

        if (resultado) {
          alert("O.S criada com sucesso!");
          fecharModal();

          console.log("üîÑ Recarregando dados da API...");
          // Recarrega dados da API e reaplica filtros
          await carregarOS();
          console.log("‚úÖ Dados recarregados - Total OS:", osEmMemoria.length);

          renderizarTabelaOS(filtroStatusAtual);
        } else {
          alert("Erro ao criar O.S. Tente novamente.");
        }
      });
    }

    // Evento do formul√°rio de novo cliente
    const formNovoCliente = document.getElementById("formNovoCliente");
    if (formNovoCliente) {
      formNovoCliente.addEventListener("submit", async function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const dados = Object.fromEntries(formData.entries());

        try {
          await adicionarCliente(dados);
          alert("Cliente cadastrado com sucesso!");
          fecharModal();
          this.reset();
        } catch (erro) {
          const mensagemErro =
            erro.message || "Erro ao processar a solicita√ß√£o. Tente novamente.";
          alert("‚ùå Erro: " + mensagemErro);
          console.error("Erro ao cadastrar cliente:", erro);
        }
      });
    }

    // Evento de busca de cliente
    const buscaCliente = document.getElementById("buscaCliente");
    if (buscaCliente) {
      buscaCliente.addEventListener("input", function (e) {
        const termo = e.target.value.trim();
        const resultados = buscarClientes(termo);
        const container = document.getElementById("resultadosBusca");

        if (container) {
          container.innerHTML = "";

          if (resultados.length === 0) {
            container.innerHTML = "<p>Nenhum cliente encontrado.</p>";
            return;
          }

          resultados.forEach((cliente) => {
            const div = document.createElement("div");
            div.className = "resultado-cliente";
            div.innerHTML = `
                                <div class="cliente-info">
                                    <div class="cliente-avatar">${cliente.nome
                                      .charAt(0)
                                      .toUpperCase()}</div>
                                    <div>
                                        <strong>${cliente.nome}</strong>
                                        <p>${cliente.telefone} | ${
              cliente.cpfCnpj
            }</p>
                                    </div>
                                </div>
                                <div class="cliente-actions">
                                    <button class="btn btn-secondary" onclick="visualizarCliente('${
                                      cliente.id
                                    }')">üëÅÔ∏è Visualizar</button>
                                    <button class="btn btn-primary" onclick="selecionarCliente('${
                                      cliente.id
                                    }')">Selecionar</button>
                                </div>
                            `;
            container.appendChild(div);
          });
        }
      });
    }

    // Formata√ß√£o autom√°tica de campos
    const cpfCnpjCliente = document.getElementById("cpfCnpjCliente");
    if (cpfCnpjCliente) {
      cpfCnpjCliente.addEventListener("input", function (e) {
        e.target.value = formatarCpfCnpj(e.target.value);
      });
    }

    const telefoneCliente = document.getElementById("telefoneCliente");
    if (telefoneCliente) {
      telefoneCliente.addEventListener("input", function (e) {
        e.target.value = formatarTelefone(e.target.value);
      });
    }

    // Eventos de filtro por status
    document.querySelectorAll(".filter-btn[data-filter]").forEach((btn) => {
      btn.addEventListener("click", function () {
        // Remove classe active de todos os bot√µes
        document
          .querySelectorAll(".filter-btn[data-filter]")
          .forEach((b) => b.classList.remove("active"));
        // Adiciona classe active no bot√£o clicado
        this.classList.add("active");

        // Atualiza filtro atual e renderiza tabela
        filtroStatusAtual = this.getAttribute("data-filter");
        renderizarTabelaOS(filtroStatusAtual);

        console.log("üîç Filtro aplicado:", filtroStatusAtual);
      });
    });

    // Eventos de filtro no modal de estoque
    const modalCategoryFilter = document.getElementById("modalCategoryFilter");
    if (modalCategoryFilter) {
      modalCategoryFilter.addEventListener("change", aplicarFiltrosModal);
    }

    // Eventos de filtros de status no modal
    document
      .querySelectorAll("#modalConsultarEstoque .filter-btn[data-filter]")
      .forEach((btn) => {
        btn.addEventListener("click", function () {
          // Remove classe active de todos os bot√µes do modal
          document
            .querySelectorAll("#modalConsultarEstoque .filter-btn[data-filter]")
            .forEach((b) => b.classList.remove("active"));
          // Adiciona classe active no bot√£o clicado
          this.classList.add("active");
          aplicarFiltrosModal();
        });
      });

    // Fechar modal ao clicar fora
    document.querySelectorAll(".modal").forEach((modal) => {
      modal.addEventListener("click", function (e) {
        if (e.target === modal) {
          fecharModal();
        }
      });
    });
  }
</script>

<style>
  /* Estilos espec√≠ficos para a p√°gina de atendimento */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }

  .stat-card {
    background: var(--bg-primary);
    padding: 25px;
    border-radius: 12px;
    box-shadow: 0 2px 8px var(--shadow-color);
    border: 2px solid var(--border-color);
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .stat-icon {
    width: 50px;
    height: 50px;
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
  }

  .stat-icon.blue {
    background: #dbeafe;
    color: #1e3a8a;
  }
  .stat-icon.green {
    background: #d1fae5;
    color: #065f46;
  }
  .stat-icon.yellow {
    background: #fef3c7;
    color: #92400e;
  }
  .stat-icon.red {
    background: #fee2e2;
    color: #dc2626;
  }

  .stat-info h3 {
    font-size: 28px;
    font-weight: 700;
    color: var(--text-primary);
    margin: 0;
  }

  .stat-info p {
    color: var(--text-secondary);
    margin: 5px 0 0 0;
    font-size: 14px;
  }

  .aparelho-info {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .aparelho-icon {
    width: 30px;
    height: 30px;
    background: var(--primary-blue);
    color: white;
    border-radius: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
  }

  .problema-cell {
    max-width: 200px;
    word-wrap: break-word;
  }

  .status-badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 600;
    display: inline-block;
  }

  .status-badge.aguardando {
    background: #fef3c7;
    color: #92400e;
  }

  .status-badge.em_reparo {
    background: #dbeafe;
    color: #1e3a8a;
  }

  .status-badge.pronto {
    background: #d1fae5;
    color: #065f46;
  }

  .status-badge.entregue {
    background: #e5e7eb;
    color: #374151;
  }

  .status-badge.cancelado {
    background: #fee2e2;
    color: #dc2626;
  }

  .resultados-busca {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 20px;
  }

  .resultado-cliente {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    margin-bottom: 10px;
    background: var(--bg-primary);
  }

  .cliente-info {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .cliente-avatar {
    width: 40px;
    height: 40px;
    background: var(--primary-blue);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  }

  .cliente-actions {
    display: flex;
    gap: 8px;
  }

  .cliente-avatar-large {
    width: 60px;
    height: 60px;
    background: var(--primary-blue);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 24px;
  }

  .client-header {
    display: flex;
    align-items: center;
    gap: 20px;
    margin-bottom: 25px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e5e7eb;
  }

  .client-info-large h3 {
    margin: 0;
    color: var(--text-primary);
    font-size: 24px;
  }

  .client-type {
    color: var(--text-secondary);
    margin: 5px 0 0 0;
  }

  .client-details-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }

  .detail-item.full-width {
    grid-column: 1 / -1;
  }

  .detail-item label {
    font-weight: 600;
    color: var(--gray-dark);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .detail-item span {
    color: var(--gray-dark);
    font-size: 14px;
  }

  .alert-item.critical {
    border-left-color: var(--red);
    background: #fee2e2;
  }

  @media (max-width: 768px) {
    .stats-grid {
      grid-template-columns: repeat(2, 1fr);
    }

    .os-table {
      font-size: 12px;
    }

    .os-table th,
    .os-table td {
      padding: 8px;
    }
  }
</style>
{% endblock %}
